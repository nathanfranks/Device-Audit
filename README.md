# Device Audit

The included scripts are used for auditing our remote connection software, AV, computer lists, and device-based billing. These are specifically built for use with ScreenConnect, Datto RMM, and Sophos. The script will grab a full list of devices from each of the 3 systems, then compares them and matches each device together as best it can to make a full list of all devices.

After the script has obtained a full list of devices it will run a series of checks: 
1. First, it looks for any duplicate devices; if it finds any in RMM or ScreenConnect it will automatically remove the one that was seen less recently. It will not remove Sophos duplicates as Sophos does not like duplicates being removed. 
2. Next, it searches for any devices that seem to be under the wrong company based on naming conventions. If something is named weirdly but is correct, you can whitelist it in the config. Otherwise it will alert you and you can manually move the device into the correct organization. 
3. The third set of checks are for issues with one system or another. It will look for devices that are broken in one system (e.g. active in RMM recently but not SC) or simply missing in one system (e.g. in RMM but not SC). The script will then attempt to automatically fix these issues by reinstalling RMM or SC (it will not install Sophos, RMM handles that). It will also check for inactive devices that haven't been seen in quite some time and remove software for old devices. The thresholds for this can be modified in the config but by default, devices are deleted from RMM after 4 months inactive, from SC after 6 months, and Sophos after a year. The delay for SC means that if the device comes back online after RMM was deleted, the script can reinstall RMM using SC.
4. Fourth, usage stats are recorded in a database. The script uses sqlite and keep a separate usage database for each customer. This data is not being used yet but will be used in the future for user audits and determining who is using which device. 
5. Lastly the system exports a billing report (if configured to) that shows the amount of workstations and servers. Based on the config file, this report can be automatically moved to a specific location. The device can consider inactive devices as unbilled. This threshold can be configured in the config file, but by default anything inactive for over a month will be unbilled.

For setup, you will find global settings for api keys and configuration in the APIKeys.ps1 and Global-Config.ps1 files (see .template files, the config files are in the "Config Files" folder). APIKeys must be filled out for this script to work. The global-config file will work with the defaults. Each customer must be setup with their own unique configuration file. Copy the Template.ps1 file and rename it to "Config-CompanyAcronym.ps1". These config files are all heavily commented to tell you exactly how they should be filled out.

When running the basic DeviceAudit script you can choose the config file by changing line 9 at the top of the script. The DeviceAudit-Automated script is similar but can be used from the command line and does not have a GUI. For this script you can set the company or multiple companies using the `companies` flag. E.g. `DeviceAudit-Automated.ps1 -companies STS, AVA, MV`. You can also set the `companies` flag to `ALL` to audit all customers at once. The company acronym used for the `companies` flag should be the CompanyAcronym portion of the "Config-CompanyAcronym.ps1" file. The DeviceAudit-Automated script is gui-less but will send emails for warnings and billing reports. The script can (and should) be ran daily to keep accurate usage logs and as such won't always send a billing report email. By default, it will send one billing report email during the last week of the month.

To automate the device audits I run a task schedule that runs 3x a day (10AM, 1PM, 4PM). The command is: `PowerShell.exe -ExecutionPolicy Bypass -File "C:\seatosky\Device Audit\DeviceAudit-Automated.ps1" -companies ALL` The script handles the rest!